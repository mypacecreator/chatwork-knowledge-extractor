# Chatwork Knowledge Extractor

Chatworkのチャット履歴から形式知化できる知見を自動抽出し、マークダウンとJSONで出力するツールです。

## 特徴

- Chatwork APIでメッセージを取得
- Claude AI (Batch API) で知見を分析・分類
- 汎用性の判定とタグ付けを自動化
- Markdown（人間向け）とJSON（機械処理用）の両形式で出力
- 低コスト（Batch API利用で50%割引）
- **定期実行でメッセージを蓄積**（100件以上の履歴を保存可能）

---

## セットアップ

### 1. インストール

```bash
npm install
```

### 2. 環境変数設定

`.env.example` をコピーして `.env` を作成し、必要な情報を入力：

```bash
cp .env.example .env
```

`.env` の内容：

```env
CHATWORK_API_TOKEN=your_chatwork_api_token
CHATWORK_ROOM_ID=your_room_id
CLAUDE_API_KEY=your_claude_api_key
DAYS_TO_EXTRACT=90
MAX_MESSAGES=500
OUTPUT_DIR=./output
```

| 変数名 | 必須 | 説明 |
|--------|------|------|
| `CHATWORK_API_TOKEN` | ✅ | Chatwork APIトークン |
| `CHATWORK_ROOM_ID` | ✅ | 対象ルームID |
| `CLAUDE_API_KEY` | ✅ | Claude APIキー |
| `DAYS_TO_EXTRACT` | - | 取得期間（日数）。省略時は全期間 |
| `MAX_MESSAGES` | - | 最大メッセージ数。デフォルト500 |
| `OUTPUT_DIR` | - | 出力先ディレクトリ。デフォルト`./output` |

### 3. APIトークンの取得

**Chatwork APIトークン:**
1. Chatworkにログイン
2. 右上のユーザー名 → 「サービス連携」→「API Token」
3. トークンを発行・コピー

**ルームID:**
- チャットを開いた時のURL `https://www.chatwork.com/#!rid123456` の `123456` 部分

**Claude APIキー:**
1. https://console.anthropic.com/ にアクセス
2. APIキーを発行

---

## 使い方

### 基本的な実行

```bash
# ビルド
npm run build

# 実行
npm start
```

開発モード（TypeScriptを直接実行）：

```bash
npm run dev
```

### 実行の流れ

```
=== Chatwork Knowledge Extractor ===

[1/4] Chatworkメッセージ取得中...
[Cache] 統計情報:
  - 保存件数: 150件
  - 最古: 2024/11/15 10:30:00
  - 最新: 2025/02/09 15:45:00
[Chatwork] 差分取得: キャッシュに150件あり
[Chatwork] API取得: 5件（新規メッセージ）
[Cache] 5件の新規メッセージを追加
[Chatwork] 合計: 155件

[2/4] Claude Batch APIで分析中...
※ バッチ処理のため、完了まで数分〜数十分かかります

[3/4] Markdown出力中...
[4/4] JSON出力中...

=== 完了 ===
```

---

## 定期実行（推奨）

### Chatwork APIの制限について

Chatwork APIは**1回のリクエストで最新100件まで**しか取得できません。
古いメッセージを遡って取得するAPIは存在しないため、**定期的に実行してメッセージを蓄積する**運用が必要です。

### 仕組み

```
[初回実行]
  → 最新100件を取得
  → cache/room_{roomId}.json に保存

[2回目以降]
  → キャッシュを読み込み
  → 前回取得以降の新規メッセージのみ取得
  → キャッシュにマージして保存
  → 蓄積されたメッセージ全体を分析
```

### 推奨スケジュール

| 用途 | 頻度 | 説明 |
|------|------|------|
| 日常的な蓄積 | 週1回 | メッセージを取りこぼさないための定期実行 |
| 案件終了時 | 随時 | 振り返りのタイミングで実行 |
| 中間振り返り | 月1回 | 進行中案件の知見整理 |

### cron設定例（毎週月曜9時に実行）

```bash
0 9 * * 1 cd /path/to/chatwork-knowledge-extractor && npm start >> logs/cron.log 2>&1
```

---

## 出力ファイル

`output/` ディレクトリに以下のファイルが生成されます：

- `knowledge_YYYY-MM-DD_HH-MM-SS.md` - Markdown形式の知見まとめ
- `knowledge_YYYY-MM-DD_HH-MM-SS.json` - JSON形式のデータ

### Markdown形式

カテゴリ別・汎用性順に整理された形式：

```markdown
# Chatwork知見まとめ

生成日時: 2025/2/9 15:30:00

---

## 📋 制作方針・指示出し

### [汎用性: high] トレイリングスラッシュの統一ルール

- **発言者**: 野村 圭
- **日時**: 2025/2/7 6:54:40
- **タグ**: `URL設計`, `SEO`, `コーディング規約`

サイト内のリンクURLにトレイリングスラッシュの有無を統一すること...
```

### JSON形式

NotebookLMや他の生成AIで二次利用可能：

```json
{
  "export_date": "2025-02-09T15:30:00.000Z",
  "total_items": 25,
  "items": [
    {
      "message_id": "2071739886704263168",
      "category": "制作方針・指示出し",
      "versatility": "high",
      "title": "トレイリングスラッシュの統一ルール",
      "tags": ["URL設計", "SEO", "コーディング規約"],
      "speaker": "野村 圭",
      "date": "2025-02-07T06:54:40.000Z",
      "formatted_content": "サイト内のリンクURLに...",
      "original_body": "確認しました。フッター..."
    }
  ]
}
```

---

## キャッシュ管理

### キャッシュファイルの場所

```
cache/
└── room_{roomId}.json
```

### キャッシュの確認

実行時に統計情報が表示されます：

```
[Cache] 統計情報:
  - 保存件数: 150件
  - 最終更新: 2025-02-09T06:30:00.000Z
  - 最古: 2024/11/15 10:30:00
  - 最新: 2025/02/09 15:45:00
```

### キャッシュのリセット

最初からやり直したい場合は、キャッシュファイルを削除してください：

```bash
rm cache/room_*.json
```

---

## カテゴリと汎用性

### カテゴリ一覧

| カテゴリ | 説明 | 出力対象 |
|----------|------|----------|
| 実装ノウハウ | コーディング、WordPress、ECサイト関連 | ✅ |
| 制作方針・指示出し | 実装や制作の方針に関する指示 | ✅ |
| トラブル対応 | エラー解決、不具合対処 | ✅ |
| 質疑応答・相談 | 判断基準、仕様確認 | ✅ |
| 定型的なやりとり | 挨拶、スケジュール調整など | ❌（除外） |

### 汎用性レベル

| レベル | 説明 | 例 |
|--------|------|-----|
| high | 他のプロジェクトでも活用できる普遍的な知見 | 「レスポンシブ画像はsrcsetを優先する理由」 |
| medium | 一部のプロジェクトで活用できる知見 | 「WordPress案件でのカスタム投稿タイプ設計」 |
| low | 特定のプロジェクトに固有の内容 | 「A社サイトのヘッダー高さは60px」 |

---

## コスト目安

Claude Batch APIは通常APIの**50%割引**が適用されます。

| メッセージ数 | 概算コスト |
|-------------|-----------|
| 100件 | $0.3〜0.5 |
| 500件 | $1.5〜2.5 |
| 1000件 | $3〜5 |

※ メッセージの長さにより変動します

---

## トラブルシューティング

### 「メッセージがありません」と表示される

- Chatworkルームにメッセージが存在するか確認
- `CHATWORK_ROOM_ID` が正しいか確認
- APIトークンに対象ルームへのアクセス権があるか確認

### Batch処理が長時間かかる

Claude Batch APIは非同期処理のため、数分〜数十分かかることがあります。
これは正常な動作です。

### 差分取得で0件になる

前回実行以降に新しいメッセージがない場合は正常です。
キャッシュされた既存メッセージは引き続き分析対象になります。

### キャッシュが壊れた場合

```bash
rm cache/room_*.json
```

でキャッシュを削除し、再実行してください。

---

## ライセンス

MIT
