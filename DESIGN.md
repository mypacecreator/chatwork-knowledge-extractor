# プロジェクト設計書

## 目的

Chatworkのチャット履歴から形式知化できる知見を自動抽出し、マークダウンとJSONで出力するツール。
日々のWeb制作案件で暗黙知的にこなしている知見を、後輩たちのために形式知化する。

## 要件

### 機能要件

1. **Chatwork API連携**
   - 指定したルームのメッセージ履歴を取得
   - 期間指定または最大件数指定で取得範囲を制御
   - レート制限（5分300回、10秒10回）に対応

2. **AI分析（Claude Batch API）**
   - 各メッセージをカテゴリ分類
   - 汎用性判定（high/medium/low）
   - 技術タグの自動生成
   - 文脈依存を排除して単独で完結する形に整形

3. **出力**
   - Markdown形式（人間が編集可能、フロントマター付き）
   - JSON形式（NotebookLMや生成AIで二次利用可能）

### 非機能要件

- **コスト優先**: Batch API使用で50%割引（月数百円程度）
- **バックグラウンド実行**: 数分〜数十分かかるが、完了を待たずに他作業可能
- **低速処理OK**: 高速性は不要

## カテゴリ

1. **実装ノウハウ** - コーディング、WordPress、ECサイト関連の技術的知見
2. **制作方針・指示出し** - 実装や制作の方針（汎用性判定フラグ付き）
3. **トラブル対応** - エラー解決、不具合対処
4. **質疑応答・相談** - 判断基準、仕様確認
5. **定型的なやりとり** - 挨拶、スケジュール調整など（除外対象）

## 技術スタック

- **言語**: Node.js + TypeScript
- **API**: 
  - Chatwork API v2
  - Claude API (Batch API)
- **主要パッケージ**:
  - `@anthropic-ai/sdk` - Claude API SDK
  - `node-fetch` - HTTP通信
  - `dotenv` - 環境変数管理

## アーキテクチャ

```
src/
├── index.ts              # エントリーポイント
├── chatwork/
│   └── client.ts         # Chatwork API処理
├── claude/
│   └── analyzer.ts       # Claude Batch API処理
├── cache/
│   └── messages.ts       # メッセージキャッシュ管理
└── formatter/
    ├── markdown.ts       # Markdown出力
    └── json.ts           # JSON出力
```

## 処理フロー

1. **メッセージ取得** (Chatwork API)
   - 最新100件を取得（force=1）
   - 期間フィルタ適用（オプション）
   - レート制限に配慮（10秒10回制限）

2. **Batch処理準備**
   - 各メッセージに対して分析プロンプトを作成
   - Batch APIリクエストを構築

3. **Batch実行** (Claude API)
   - Batch作成
   - 完了を待機（10秒ごとにポーリング）
   - 結果取得・パース

4. **出力**
   - カテゴリ別、汎用性順にソート
   - Markdown生成（フロントマター形式）
   - JSON生成

## 重要な設計判断

### 汎用性判定の目的

「制作方針・指示出し」の中に、案件固有の指示と汎用的な知見が混在する。
汎用性フラグを付けることで、人間が最終判断しやすくする。

**例:**
- 汎用性 high: 「レスポンシブ画像はpictureよりsrcsetを優先する理由」
- 汎用性 low: 「A社サイトのヘッダー高さは60px」

### 形式知化の基準

**単独で完結する知見として整形**
- 「これ」「それ」などの指示語を具体的に
- 前提条件や背景を補足
- 文脈がなくても理解・実践できる形に

### Chatwork APIの制限

**API仕様上の制限:**
- 1回のリクエストで最大100件まで
- 古いメッセージを遡って取得するAPIは存在しない
- ページネーション未実装

**現在の実装（定期バックアップ方式）:**
- 初回: `force=1`で最新100件を取得しキャッシュ保存
- 2回目以降: `force=0`で差分取得し、キャッシュにマージ
- 継続的に実行することで100件以上のメッセージを蓄積可能

```
cache/
└── room_{roomId}.json  # ルームごとのメッセージキャッシュ
```

### Claude Batch APIの利点

- **50%割引**: 通常のAPIの半額
- **非同期**: バックグラウンドで処理、他の作業が可能
- **コスト見込み**: 
  - 100件: $0.3〜0.5
  - 500件: $1.5〜2.5

## 環境変数

```env
CHATWORK_API_TOKEN=     # Chatwork APIトークン
CHATWORK_ROOM_ID=       # 対象ルームID
CLAUDE_API_KEY=         # Claude APIキー
DAYS_TO_EXTRACT=90      # 取得期間（日数、オプション）
MAX_MESSAGES=500        # 最大メッセージ件数
OUTPUT_DIR=./output     # 出力先ディレクトリ
```

## 開発の背景

- **対象ユーザー**: Web制作チーム、フリーランス
- **利用シーン**: 案件終了時の振り返り、中間振り返り
- **二次利用**: NotebookLM、生成AI、社内Wiki

## 今後の拡張可能性

1. **分析済みスキップ**: 既に分析したメッセージを再分析しない最適化
2. **GUI追加**: Webインターフェース
3. **フィルタ機能**: 発言者、タグでの絞り込み
4. **通知機能**: Batch完了時の通知
5. **OSS化**: GitHubでの公開

## セキュリティ

- APIキーは `.env` で管理
- `.env` は `.gitignore` で除外
- リポジトリ公開前に必ず `.env` の除外を確認

## 開発履歴

- 2025-02-07: Claude.aiチャットで初期設計・実装完了
- 2025-02-09: Claude Codeで動作確認・改善
  - Batch API SDK互換性修正（beta.messages.batches）
  - JSONパースエラー修正（マークダウンコードブロック対応）
  - 定期バックアップ機能実装（メッセージキャッシュ）
